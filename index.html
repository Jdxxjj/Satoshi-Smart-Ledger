<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Satoshi Smart Ledger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- ใช้ ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <style>
    body{font-family:"Tahoma",Arial,sans-serif;margin:0;background:#f8f9fb;color:#333}
    .tabs{display:flex;background:#222}
    .tabs button{flex:1;padding:16px;border:none;background:#333;color:#bbb;cursor:pointer;transition:.2s}
    .tabs button.active{background:#B27A01;color:#fff;font-weight:700}
    .page{display:none;padding:20px}
    .page.active{display:block}
    .card{max-width:1140px;margin:20px auto;background:#fff;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.1);padding:24px}
    h2{margin:0 0 16px;color:#222}
    label{display:block;margin-top:14px;font-weight:600;font-size:.95rem;color:#444}
    input,select{width:100%;padding:12px 14px;margin-top:6px;border:1px solid #ddd;border-radius:10px;font-size:1rem;box-sizing:border-box;background:#fafafa;transition:.2s}
    input:focus,select:focus{outline:none;border-color:#B27A01;background:#fff;box-shadow:0 0 0 2px rgba(178,122,1,.15)}
    .error{color:#d93025;font-size:.85rem;margin-top:4px;min-height:18px}
    .error-input{border-color:#d93025 !important}
    .toggle{display:flex;gap:12px;margin:18px 0}
    .toggle button{flex:1;padding:14px;border:none;border-radius:12px;background:#eee;color:#444;cursor:pointer;transition:.2s;font-size:1rem}
    .toggle button.selected{background:#B27A01;color:#fff;font-weight:600}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .full{grid-column:1/-1}
    .submit{margin-top:24px;width:100%;padding:15px;background:#333;color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:1.05rem;font-weight:600;transition:.2s}
    .submit:hover{background:#B27A01}
    .amount-display{margin-top:6px;color:#777;font-style:italic}
    @media (max-width:780px){.row{grid-template-columns:1fr}}

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:999}
    .modal .box{background:#fff;border-radius:14px;max-width:520px;width:100%;padding:22px;box-shadow:0 6px 16px rgba(0,0,0,.2)}
    .modal h3{margin:0 0 14px}
    .modal .btns{display:flex;justify-content:flex-end;gap:10px;margin-top:18px}
    .btn{padding:10px 16px;border:none;border-radius:8px;cursor:pointer}
    .btn-ok{background:#06c755;color:#fff}
    .btn-cancel{background:#d93025;color:#fff}

    #popup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2000;justify-content:center;align-items:center}
    #popupBox{background:#fff;padding:24px 28px;border-radius:12px;font-size:1.2rem;box-shadow:0 4px 12px rgba(0,0,0,.2)}

    #progressWrap{margin-top:10px;display:none}
    #progressBar{width:100%;height:14px;border-radius:8px;background:#eee;overflow:hidden}
    #progressBar div{height:100%;width:0;background:#06c755;transition:width .3s}

    /* Dashboard */
    .dash{display:flex;flex-wrap:wrap;gap:22px;align-items:flex-start;justify-content:center}
    #donutWrap{width:420px;height:420px}
    .summary{min-width:300px;max-width:520px;flex:1;background:#fff;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:18px}
    .summary h3{margin:0 0 12px}
    .crumbs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .crumb{background:#f1f5f9;border:1px solid #e2e8f0;padding:6px 10px;border-radius:999px;font-size:.85rem}
    .btn-back{margin-bottom:10px}
    .legend-item{display:flex;align-items:center;gap:8px;margin:6px 0}
    .legend-dot{width:12px;height:12px;border-radius:50%}
  </style>
</head>
<body>
  <div class="tabs">
    <button class="tab active" data-id="add">เพิ่มรายการ</button>
    <button class="tab" data-id="history">ประวัติ</button>
    <button class="tab" data-id="dashboard">แดชบอร์ด</button>
  </div>

  <section id="add" class="page active">
    <div class="card"><h2>เพิ่มรายการ</h2></div>
  </section>

  <section id="history" class="page">
    <div class="card"><h2>ประวัติการทำรายการ</h2><div id="historyList"></div></div>
  </section>

  <section id="dashboard" class="page">
    <div class="card">
      <h2>แดชบอร์ด</h2>
      <div class="crumbs" id="dbCrumbs"></div>
      <button class="btn btn-ok btn-back" id="dbBack" style="display:none">ย้อนกลับ</button>
      <div class="dash">
        <div id="donutWrap"><div id="donutChart" style="width:100%;height:100%"></div></div>
        <div class="summary" id="summaryBox"></div>
      </div>
    </div>
  </section>

<script>
const API_URL="https://satoshi-smart-ledger.tttta2556.workers.dev/"
let records=[],echart=null
let drill={level:0,path:[],dims:['project','building','jobType','category','paymentType']}

function rndColor(i){
  const base=["#0ea5e9","#22c55e","#f97316","#a855f7","#eab308","#ef4444","#06b6d4","#84cc16","#f43f5e","#14b8a6"]
  return base[i%base.length]
}

function groupExpense(arr,key){
  const m={}
  arr.filter(r=>r.mode==="จ่าย").forEach(r=>{
    const k=(r[key]||"ไม่ระบุ").trim()
    m[k]=(m[k]||0)+Math.abs(Number(r.amount)||0)
  })
  return m
}
function sumIncome(arr){return arr.filter(r=>r.mode==="เบิก").reduce((s,r)=>s+Math.abs(Number(r.amount)||0),0)}

function applyPath(arr){
  let out=arr.slice()
  drill.path.forEach(p=>{
    out=out.filter(r=> (r[p.dim]||"ไม่ระบุ")===p.value && r.mode==="จ่าย")
  })
  return out
}

function renderDonut(labels,values,colors,title,legend){
  if(echart){echart.dispose()}
  echart=echarts.init(document.getElementById("donutChart"))
  echart.setOption({
    title:{text:title,left:"center"},
    tooltip:{trigger:"item",formatter:"{b}: {c} บาท ({d}%)"},
    legend:{show:false},
    series:[{type:"pie",radius:["40%","70%"],label:{show:false},data:labels.map((l,i)=>({value:values[i],name:l,itemStyle:{color:colors[i]}}))}]
  })
  echart.on("click",params=>{
    const label=params.name
    if(drill.level===0 && label==="เงินคงเหลือ") return
    goDeeper(label)
  })
  const box=document.getElementById("summaryBox")
  box.innerHTML=`<h3>${title}</h3>` + legend.map(x=>`
    <div class="legend-item"><span class="legend-dot" style="background:${x.color}"></span>
    <span>${x.label}</span><b style="margin-left:auto">${x.value.toLocaleString()} บาท</b></div>`).join("")
}

function renderDrill(){
  const data=records
  const totalFunds=sumIncome(data)
  if(drill.level===0){
    const byProject=groupExpense(data,'project')
    const spentSum=Object.values(byProject).reduce((a,b)=>a+b,0)
    const remaining=Math.max(totalFunds-spentSum,0)
    const labels=["เงินคงเหลือ",...Object.keys(byProject)]
    const values=[remaining,...Object.values(byProject)]
    const colors=["#cbd5e1",...labels.slice(1).map((_,i)=>rndColor(i))]
    const legend=[{label:"เงินคงเหลือ",value:remaining,color:"#cbd5e1"}].concat(Object.keys(byProject).map((k,i)=>({label:k,value:byProject[k],color:colors[i+1]})))
    renderDonut(labels,values,colors,"ภาพรวม",legend)
  }else{
    let scoped=applyPath(data)
    const dim=drill.dims[drill.level]
    const parent=drill.path[drill.path.length-1]?.value||""
    const by=groupExpense(scoped,dim)
    const labels=Object.keys(by)
    const vals=Object.values(by)
    const colors=labels.map((_,i)=>rndColor(i))
    const legend=labels.map((k,i)=>({label:k,value:by[k],color:colors[i]}))
    renderDonut(labels,vals,colors,`${parent} → ${dim}`,legend)
  }
  document.getElementById("dbCrumbs").innerHTML=[{dim:"ภาพรวม",value:"ทั้งหมด"}].concat(drill.path).map((p,i)=> i===0?`<span class="crumb">ภาพรวม</span>`:`<span class="crumb">${p.dim}: ${p.value}</span>`).join("")
  document.getElementById("dbBack").style.display=drill.level>0?"inline-block":"none"
}
function goDeeper(label){
  if(drill.level===0){drill.path.push({dim:'project',value:label});drill.level=1}
  else if(drill.level<drill.dims.length){drill.path.push({dim:drill.dims[drill.level],value:label});if(drill.level<drill.dims.length-1)drill.level++}
  renderDrill()
}
document.getElementById("dbBack").addEventListener("click",()=>{if(drill.level===0)return;drill.path.pop();drill.level=Math.max(0,drill.level-1);renderDrill()})

async function loadOptions(){
  const d=await fetch(API_URL).then(r=>r.json())
  records=d.items||[]
  renderDrill()
}
window.addEventListener("DOMContentLoaded",async()=>{await loadOptions()})
</script>
</body>
</html>
